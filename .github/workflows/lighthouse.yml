name: 'Lighthouse'

on:
  deployment_status:

jobs:
  lighthouse-production:
    name: Production
    if: ${{ github.event.deployment_status.state == 'success' && github.event.deployment.production_environment }}
    permissions:
      deployments: read
      actions: read
      contents: read
      security-events: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: './.lighthouse/lighthouserc.cjs'
          # uploadArtifacts: true # save results as an action artifacts
          # temporaryPublicStorage: true # upload lighthouse report to the temporary storage
          urls: |
            ${{ github.event.deployment_status.environment_url }}
            ${{ github.event.deployment_status.environment_url }}/code/github-actions/gh-pages?theme=light
            ${{ github.event.deployment_status.environment_url }}/code/github-actions/gh-pages?theme=dark
            ${{ github.event.deployment_status.environment_url }}/code/components/pagination
            ${{ github.event.deployment_status.environment_url }}/games/minesweeper
            ${{ github.event.deployment_status.environment_url }}/embeds/v1/minesweeper
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
  lighthouse-pr:
    name: PR
    if: ${{ github.event.deployment_status.state == 'success' && !github.event.deployment.production_environment }}
    permissions:
      deployments: read
      actions: read
      contents: read
      security-events: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - run: echo "target_url ${{ github.event.deployment_status.target_url }}"
      - uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: './.lighthouse/lighthouserc.cjs'
          # uploadArtifacts: true # save results as an action artifacts
          # temporaryPublicStorage: true # upload lighthouse report to the temporary storage
          urls: ${{ github.event.deployment_status.environment_url }}
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  # Post comment with changed URLs after PR deployment succeeds
  comment-changed-urls:
    name: Comment changed URLs
    if: ${{ github.event.deployment_status.state == 'success' && !github.event.deployment.production_environment }}
    permissions:
      deployments: read
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'npm'
      - name: Get PR number
        id: get-pr
        uses: actions/github-script@v7
        with:
          script: |
            // Get the PR associated with this deployment
            const deployment = context.payload.deployment;
            if (deployment && deployment.payload && deployment.payload.pr_id) {
              return deployment.payload.pr_id;
            }
            // Fallback: try to find PR by ref
            const ref = deployment?.ref;
            if (ref) {
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${ref}`
              });
              if (prs.data.length > 0) {
                return prs.data[0].number;
              }
            }
            return null;
          result-encoding: string
      - name: Get changed files and format comment
        if: steps.get-pr.outputs.result != 'null'
        id: format-message
        uses: actions/github-script@v7
        env:
          REVIEW_BASE_URL: ${{ github.event.deployment_status.environment_url }}
          PR_NUMBER: ${{ steps.get-pr.outputs.result }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER);
            const reviewBaseUrl = process.env.REVIEW_BASE_URL;
            const productionBaseUrl = 'https://svelper.com';

            // Get changed files from the PR
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                per_page: 100
              }
            );
            const changedFiles = files.map(file => file.filename);

            // Import the detection script
            const { default: getChangedPagePaths } = await import('${{ github.workspace }}/.github/scripts/detect-changed-sveltekit-paths.js');
            const paths = await getChangedPagePaths('${{ github.workspace }}', changedFiles);

            if (paths.length === 0) {
              core.setOutput('message', '# URLs changed in this PR\n\nNo pages were affected by the changes in this PR.');
              return;
            }

            const tableRows = paths.map(p => {
              const reviewUrl = `${reviewBaseUrl}${p}`;
              const productionUrl = `${productionBaseUrl}${p}`;
              return `| [${p}](${reviewUrl}) | [pro](${productionUrl}) |`;
            });

            const message = [
              '# URLs changed in this PR',
              '',
              '| Review | Production |',
              '| --- | --- |',
              ...tableRows,
            ].join('\n');

            core.setOutput('message', message);
      - name: Comment changed URLs
        if: steps.get-pr.outputs.result != 'null'
        uses: mshick/add-pr-comment@v2
        with:
          issue: ${{ steps.get-pr.outputs.result }}
          message: |
            ${{ steps.format-message.outputs.message }}
