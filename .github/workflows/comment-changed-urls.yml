name: 'Comment Changed URLs'

on:
  deployment_status:

jobs:
  comment-changed-urls:
    name: Comment changed URLs
    if: ${{ github.event.deployment_status.state == 'success' && !github.event.deployment.production_environment }}
    permissions:
      deployments: read
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'npm'
      - name: Get PR number
        id: get-pr
        uses: actions/github-script@v7
        with:
          script: |
            // Get the PR associated with this deployment
            const deployment = context.payload.deployment;
            
            // Try to get PR ID from deployment payload (if Vercel includes it)
            if (deployment && deployment.payload && deployment.payload.pr_id) {
              console.log('Found PR ID in deployment payload:', deployment.payload.pr_id);
              return deployment.payload.pr_id;
            }
            
            // Try to find PR by deployment SHA (deployment.sha contains the commit SHA)
            const sha = deployment?.sha;
            console.log('Deployment SHA:', sha);
            
            if (sha) {
              // Find PRs associated with this commit
              const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: sha
              });
              console.log('Found PRs:', prs.data.length);
              if (prs.data.length > 0) {
                // Return the first open PR (or the first one if none are open)
                const openPr = prs.data.find(pr => pr.state === 'open');
                const prNumber = openPr ? openPr.number : prs.data[0].number;
                console.log('Using PR number:', prNumber);
                return prNumber;
              }
            }
            
            console.log('No PR found for this deployment');
            return null;
          result-encoding: string
      - name: Get changed files and format comment
        if: steps.get-pr.outputs.result != 'null'
        id: format-message
        uses: actions/github-script@v7
        env:
          REVIEW_BASE_URL: ${{ github.event.deployment_status.environment_url }}
          PR_NUMBER: ${{ steps.get-pr.outputs.result }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER);
            const reviewBaseUrl = process.env.REVIEW_BASE_URL;
            const productionBaseUrl = 'https://svelper.com';

            // Get changed files from the PR
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                per_page: 100
              }
            );
            const changedFiles = files.map(file => file.filename);

            // Import the detection script
            const { default: getChangedPagePaths } = await import('${{ github.workspace }}/.github/scripts/detect-changed-sveltekit-paths.js');
            const paths = await getChangedPagePaths('${{ github.workspace }}', changedFiles);

            if (paths.length === 0) {
              core.setOutput('message', '# URLs changed in this PR\n\nNo pages were affected by the changes in this PR.');
              return;
            }

            const tableRows = paths.map(p => {
              const reviewUrl = `${reviewBaseUrl}${p}`;
              const productionUrl = `${productionBaseUrl}${p}`;
              return `| [${p}](${reviewUrl}) | [pro](${productionUrl}) |`;
            });

            const message = [
              '# URLs changed in this PR',
              '',
              '| Review | Production |',
              '| --- | --- |',
              ...tableRows,
            ].join('\n');

            core.setOutput('message', message);
      - name: Comment changed URLs
        if: steps.get-pr.outputs.result != 'null'
        uses: mshick/add-pr-comment@v2
        with:
          issue: ${{ steps.get-pr.outputs.result }}
          message: |
            ${{ steps.format-message.outputs.message }}
